#!/bin/sh
#
# Pull in a dirty repository (Stash, pull & apply)
#
# This custom git command (git stash-pull-apply) performs all of these
# steps. This can be used as a convinient method to pull into a dirty
# directory.
#
# If any step fails, the process is aborted and must continue
# manually.

function git_dirty_files() {
    [ $(git status --porcelain 2>/dev/null | grep -v "^??" | wc -l) != "0" ]
}

git fetch --verbose || exit 1
branch=$(git rev-parse --abbrev-ref HEAD)
ahead=$(git rev-list --left-right origin/${branch}...HEAD | grep "^>" | wc -l)
behind=$(git rev-list --left-right origin/${branch}...HEAD | grep "^<" | wc -l)
if [ $behind = 0 ]; then
    echo Already up to date
    exit
fi

if git_dirty_files; then
    if git stash; then
	if git pull --rebase; then
	    git stash apply
	else
	    echo "Pull failed - local changes are still in stash (Run \"git stash apply\" to apply them)"
	fi
    fi
else
    git pull
fi
